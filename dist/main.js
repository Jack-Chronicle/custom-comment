"use strict";var Y=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var ce=(T,k)=>{for(var i in k)Y(T,i,{get:k[i],enumerable:!0})},he=(T,k,i,d)=>{if(k&&typeof k=="object"||typeof k=="function")for(let g of ae(k))!oe.call(T,g)&&g!==i&&Y(T,g,{get:()=>k[g],enumerable:!(d=re(k,g))||d.enumerable});return T};var de=T=>he(Y({},"__esModule",{value:!0}),T);var me={};ce(me,{default:()=>K});module.exports=de(me);var ee=require("obsidian");var Z={template:"%% {cursor} %%",wordOnlyMode:!1,additionalMarkers:[]};var V=require("obsidian"),J=class extends V.PluginSettingTab{constructor(k,i){super(k,i),this.plugin=i}display(){let{containerEl:k}=this;k.empty(),new V.Setting(k).setName("Comment Format").setDesc("Use {cursor} wherever you want the cursor to go (e.g. '%% {cursor} %%' or '<!-- {cursor} -->').").addText(d=>d.setValue(this.plugin.settings.template).onChange(async g=>{this.plugin.settings.template=g||"%% {cursor} %%",await this.plugin.saveSettings()})),new V.Setting(k).setName("Word-only toggle mode").setDesc("If enabled, toggling will un/comment the word at the cursor's location rather than inserting a comment at the cursor position.").addToggle(d=>d.setValue(!!this.plugin.settings.wordOnlyMode).onChange(async g=>{this.plugin.settings.wordOnlyMode=g,await this.plugin.saveSettings()})),k.createEl("h3",{text:"Additional Marker Sets"}),(this.plugin.settings.additionalMarkers||[]).forEach((d,g)=>{let E=new V.Setting(k).setName(`Marker Set ${g+1}`).addToggle(C=>C.setValue(!!d.registerCommand).onChange(async c=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[g].registerCommand=c,await this.plugin.saveSettings(),this.plugin.registerMarkerCommands(!0),this.display())})).addText(C=>C.setPlaceholder("Start marker").setValue(d.start).onChange(async c=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[g].start=c,await this.plugin.saveSettings())})).addText(C=>C.setPlaceholder("End marker").setValue(d.end).onChange(async c=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[g].end=c,await this.plugin.saveSettings())})).addExtraButton(C=>C.setIcon("cross").setTooltip("Remove marker set").onClick(async()=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers.splice(g,1),await this.plugin.saveSettings(),this.display())}))}),new V.Setting(k).addButton(d=>d.setButtonText("Add Marker Set").setCta().onClick(async()=>{this.plugin.settings.additionalMarkers||(this.plugin.settings.additionalMarkers=[]),this.plugin.settings.additionalMarkers.push({start:"",end:"",registerCommand:!1}),await this.plugin.saveSettings(),this.display()}))}};function S(...T){console.log("[CustomComment DEV]",...T)}var ge=[{start:"%%",end:"%%"},{start:"<!--",end:"-->"},{start:"//",end:""}],K=class extends ee.Plugin{constructor(){super(...arguments);this._markerCommandIds=[];this._cleanupGuard=!1}async onload(){S("Plugin loading..."),await this.loadSettings(),this.addSettingTab(new J(this.app,this)),this.addCommand({id:"reload-marker-commands",name:"Reload Marker Commands",callback:()=>this.registerMarkerCommands(!0)}),this.registerMarkerCommands()}registerMarkerCommands(i=!1){i&&this._markerCommandIds&&(this._markerCommandIds=[]),this._markerCommandIds=[];let d=this.settings.template??"%% {cursor} %%",g=d.indexOf("{cursor}"),E="%%",C="%%";g!==-1&&(E=d.slice(0,g).trim()||"%%",C=d.slice(g+8).trim()||"%%");let c="toggle-comment-template";this.addCommand({id:c,name:`Toggle Comment: (${E}|${C})`,editorCallback:m=>this.toggleComment(m)}),this._markerCommandIds.push(c),Array.isArray(this.settings.additionalMarkers)&&this.settings.additionalMarkers.forEach((m,M)=>{if(m&&m.registerCommand){let v=`toggle-comment-marker-set-${M+1}`;this.addCommand({id:v,name:(()=>{let I=m.start?.trim()||"%%",_=m.end?.trim()||"%%";return`Toggle Marker ${M+1}: (${I}|${_})`})(),checkCallback:(I,_)=>(!I&&_&&this.toggleComment(_,m),!0)}),this._markerCommandIds.push(v)}}),S("Marker commands registered:",this._markerCommandIds)}async loadSettings(){this.settings=Object.assign({},Z,await this.loadData()),S("Settings loaded:",this.settings)}async saveSettings(){await this.saveData(this.settings),S("Settings saved:",this.settings)}async reloadPlugin(){await this.app.plugins.disablePlugin(this.manifest.id),await this.app.plugins.enablePlugin(this.manifest.id),S("Plugin reloaded")}insertComment(i){let d=this.settings.template,g=d.indexOf("{cursor}");if(g===-1){i.replaceSelection(d),S("Inserted template (no cursor placeholder)");return}let E=d.slice(0,g).trim(),C=d.slice(g+8).trim(),c=`${E} ${C}`.replace(/\s+/g," ").trim(),m=i.getCursor();i.replaceSelection(`${E}  ${C}`.replace(/\s+/g," ").replace(" "," {cursor} "));let M=E.split(`
`),v=M.length-1,I=M[M.length-1].length+1;i.setCursor({line:m.line+v,ch:(v?0:m.ch)+I}),S("Inserted comment at cursor")}toggleComment(i,d){S("toggleComment called",{selection:i.getSelection(),cursor:i.getCursor(),markerSet:d});let g,E;if(d)g=d.start.trim(),E=d.end.trim();else{let n=this.settings.template,s=n.indexOf("{cursor}"),h=n,o="";s!==-1&&(h=n.slice(0,s),o=n.slice(s+8)),g=h.trim(),E=o.trim()}function C(n){return n.replace(/\s+/g," ").trim()}let c=C(g),m=C(E);function M(n,s){let h=s.indexOf(n);if(h!==-1)return{idx:h,full:!0};for(let o=n.length-1;o>0;o--){if(s.includes(n.slice(0,o)))return{idx:s.indexOf(n.slice(0,o)),full:!1,partial:n.slice(0,o)};if(s.includes(n.slice(-o)))return{idx:s.indexOf(n.slice(-o)),full:!1,partial:n.slice(-o)}}return{idx:-1,full:!1}}function v({line:n,marker:s,partialIdx:h,isStart:o,otherMarker:O,uniqueMarkers:e=!0}){let t=s.length,a=-1;for(let u=Math.max(0,h-t+1);u<=h;u++)if(n.slice(u,u+t)===s){a=u;break}if(a===-1){for(let u=h;u<=Math.min(n.length-t,h+t-1);u++)if(n.slice(u,u+t)===s){a=u;break}}if(a===-1)return{confirmed:!1};if(o){let u=n.indexOf(O,a+t);if(u===-1)return{confirmed:!1};if(e){let f=n.indexOf(s,a+t);if(f!==-1&&f<u)return{confirmed:!1}}return{confirmed:!0,startIdx:a,endIdx:u}}else{let u=n.lastIndexOf(O,a-1);if(u===-1)return{confirmed:!1};if(e){let f=n.lastIndexOf(s,a-1);if(f!==-1&&f>u)return{confirmed:!1}}return{confirmed:!0,startIdx:u,endIdx:a}}}function I(n,s,h){return h==="back"?P.lastIndexOf(n,s):P.indexOf(n,s)}function _(n,s,h){let o=n.trim();return s&&h?o.startsWith(s)&&o.endsWith(h):s?o.startsWith(s):!1}function q(n){for(let s of ge){let h=C(s.start),o=C(s.end);if(_(n,h,o))return{found:!0,markerStart:s.start,markerEnd:s.end}}return{found:!1}}let b=i.getSelection(),w=i.getCursor(),r=i.getCursor("from"),l=i.getCursor("to"),P=i.getLine(w.line),W,R=null;function te(n,s){let h=/[\p{L}\p{N}_]+/gu,o;for(;(o=h.exec(n))!==null;)if(s>=o.index&&s<=o.index+o[0].length)return{start:o.index,end:o.index+o[0].length};return null}b?W=b:(R=te(P,w.ch),R&&w.ch>R.start&&w.ch<R.end?(W=P.slice(R.start,R.end),r={line:w.line,ch:R.start},l={line:w.line,ch:R.end}):(W="",r={line:w.line,ch:w.ch},l={line:w.line,ch:w.ch}));let z=-1,H=-1,D="",ne=!1,A=c,B=m,ue=!!(A&&B&&A!==B);S("[Detection] selection:",b),S("[Detection] text:",W);let ie=M(c,W),se=M(m,W);if(S("[Detection] foundStart:",ie),S("[Detection] foundEnd:",se),b){let n=[],s=[],h=i.lineCount();for(let e=0;e<h;e++){let t=i.getLine(e),a=0;for(;(a=t.indexOf(c,a))!==-1;)n.push({line:e,ch:a}),a+=c.length;for(a=0;(a=t.indexOf(m,a))!==-1;)s.push({line:e,ch:a}),a+=m.length}let o=null,O=[];for(let e=0,t=0,a=0;e<n.length+s.length;){let u=t<n.length?n[t]:null,f=a<s.length?s[a]:null,X=!1;if(u&&(!f||u.line<f.line||u.line===f.line&&u.ch<f.ch))O.push(u),t++,X=!0;else if(f){if(O.length>0){let $=O.pop();if($){let N=f,F={line:$.line,ch:$.ch},p={line:N.line,ch:N.ch+m.length},x=r,y=l,L=(x.line<p.line||x.line===p.line&&x.ch<p.ch)&&(y.line>F.line||y.line===F.line&&y.ch>F.ch),U=y.line<F.line||y.line===F.line&&y.ch<=F.ch,G=x.line>p.line||x.line===p.line&&x.ch>=p.ch;if(L&&!U&&!G){o={start:$,end:N};break}}}a++}else break}if(o){let{start:e,end:t}=o,a=0;i.getLine(e.line)[e.ch+c.length]===" "&&(a=1);let f=0,X=i.getLine(t.line);t.ch>0&&X[t.ch-1]===" "&&(f=1);let $=0,N=0,F=0;e.line===r.line&&(e.ch<r.ch?$+=c.length+a:e.ch>=r.ch&&e.ch<l.ch&&r.line===l.line&&(F+=c.length+a)),t.line===l.line&&(t.ch<l.ch?N+=m.length+f:t.ch>=r.ch&&t.ch<l.ch&&r.line===l.line&&(F+=m.length+f));let p={},x={};e.line===r.line&&e.ch<r.ch||e.line===l.line&&e.ch<l.ch?p[e.line]=(p[e.line]||0)+c.length+a:(e.line>r.line&&e.line<l.line||e.line===r.line&&e.ch>=r.ch&&(r.line!==l.line||e.ch<l.ch))&&(x[e.line]=(x[e.line]||0)+c.length+a),t.line===l.line&&t.ch<l.ch||t.line===r.line&&t.ch<r.ch?p[t.line]=(p[t.line]||0)+m.length+f:(t.line>r.line&&t.line<l.line||t.line===l.line&&t.ch>=r.ch&&(r.line!==l.line||t.ch<l.ch))&&(x[t.line]=(x[t.line]||0)+m.length+f),i.transaction({changes:[{from:{line:t.line,ch:t.ch-f},to:{line:t.line,ch:t.ch+m.length},text:""},{from:{line:e.line,ch:e.ch},to:{line:e.line,ch:e.ch+c.length+a},text:""}]});let y={...r},L={...l};p[y.line]&&(y.ch=Math.max(0,y.ch-p[y.line])),(p[L.line]||x[L.line])&&(L.ch=Math.max(y.ch,L.ch-(p[L.line]||0)-(x[L.line]||0)));let U=[];for(let G in p){let j=Number(G);U.push({line:j,type:"before",count:p[j]})}for(let G in x){let j=Number(G);U.push({line:j,type:"within",count:x[j]})}S("Uncommented marker pair encompassing selection",{from:r,to:l,pairToRemove:o,removedBefore:p,removedWithin:x,selFrom:y,selTo:L,removedCharsLog:U}),i.setSelection(y,L);return}if(b){let e=i.getRange(r,l),t=c+(e?" ":"")+e+(e?" ":"")+m;i.replaceRange(t,r,l);let a=c.length+(e?1:0),u={line:r.line,ch:r.ch+a},f;r.line===l.line?f={line:l.line,ch:l.ch+a}:f={line:l.line,ch:l.ch},i.setSelection(u,f),S("Commented region (no marker pair found)",{from:r,to:l,commented:t});return}}else return;if(ne){let n=P.slice(0,z),s=P.slice(B&&H!==-1?H+B.length:P.length),h=0;D.startsWith(" ")&&(D=D.slice(1),h=1);let o=0;D.endsWith(" ")&&(D=D.slice(0,-1),o=1);let O=n+D+s;if(i.setLine(w.line,O),b){let e=r.ch,t=l.ch;r.ch<=z+A.length+h?e=z:e=r.ch-A.length+h,B&&H!==-1&&l.ch>=H?t=z+D.length:t=l.ch-A.length+h,e=Math.max(0,e),t=Math.max(e,t);let a={line:w.line,ch:e},u={line:w.line,ch:t};i.setSelection(a,u),S("Uncommented region",{from:r,to:l,region:D})}else return}else if(b){let n=i.getRange(r,l),s=A+(n?" ":"")+n+(n?" ":"")+B;i.replaceRange(s,r,l);let h=A.length+(n?1:0),o=B.length+(n?1:0),O={line:r.line,ch:r.ch+h},e;r.line===l.line?e={line:l.line,ch:l.ch+h}:e={line:l.line,ch:l.ch},i.setSelection(O,e),S("Commented region",{from:r,to:l,commented:s})}else return;function le(n){let s=i.getValue().split(`
`),h=Math.max(0,Math.min(n.line,s.length-1)),o=Math.max(0,Math.min(n.ch,s[h]?.length??0));return{line:h,ch:o}}let Q=le(i.getCursor());(Q.line!==i.getCursor().line||Q.ch!==i.getCursor().ch)&&i.setCursor(Q)}toggleCommentAtCursor(i){let d=this.settings.template,g=d.indexOf("{cursor}"),E=d,C="";g!==-1&&(E=d.slice(0,g),C=d.slice(g+8));let c=E.trim(),m=C.trim(),M=i.getCursor(),v=i.getLine(M.line),I=v.indexOf(c),_=m?v.lastIndexOf(m):-1,q=!1;if(c&&m?q=I!==-1&&_!==-1&&M.ch>=I+c.length&&M.ch<=_+m.length:c&&(q=I!==-1&&M.ch>=I+c.length),q){let b=v;c&&(b=b.replace(c,"")),m&&(b=b.replace(m,"")),b=b.trim(),i.setLine(M.line,b)}}};
//# sourceMappingURL=main.js.map
