"use strict";var U=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var oe=Object.prototype.hasOwnProperty;var ae=(c,o)=>{for(var e in o)U(c,e,{get:o[e],enumerable:!0})},ce=(c,o,e,n)=>{if(o&&typeof o=="object"||typeof o=="function")for(let a of re(o))!oe.call(c,a)&&a!==e&&U(c,a,{get:()=>o[a],enumerable:!(n=le(o,a))||n.enumerable});return c};var me=c=>ce(U({},"__esModule",{value:!0}),c);var ge={};ae(ge,{default:()=>V});module.exports=me(ge);var K=require("obsidian");var q={template:"%% {cursor} %%",wordOnlyMode:!1,additionalMarkers:[]};var L=require("obsidian"),B=class extends L.PluginSettingTab{constructor(o,e){super(o,e),this.plugin=e}display(){let{containerEl:o}=this;o.empty(),new L.Setting(o).setName("Comment Format").setDesc("Use {cursor} wherever you want the cursor to go (e.g. '%% {cursor} %%' or '<!-- {cursor} -->').").addText(n=>n.setValue(this.plugin.settings.template).onChange(async a=>{this.plugin.settings.template=a||"%% {cursor} %%",await this.plugin.saveSettings()})),new L.Setting(o).setName("Word-only toggle mode").setDesc("If enabled, toggling will un/comment the word at the cursor's location rather than inserting a comment at the cursor position.").addToggle(n=>n.setValue(!!this.plugin.settings.wordOnlyMode).onChange(async a=>{this.plugin.settings.wordOnlyMode=a,await this.plugin.saveSettings()})),o.createEl("h3",{text:"Additional Marker Sets"}),(this.plugin.settings.additionalMarkers||[]).forEach((n,a)=>{let k=new L.Setting(o).setName(`Marker Set ${a+1}`).addToggle(m=>m.setValue(!!n.registerCommand).onChange(async g=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[a].registerCommand=g,await this.plugin.saveSettings(),this.plugin.registerMarkerCommands(!0),this.display())})).addText(m=>m.setPlaceholder("Start marker").setValue(n.start).onChange(async g=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[a].start=g,await this.plugin.saveSettings())})).addText(m=>m.setPlaceholder("End marker").setValue(n.end).onChange(async g=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[a].end=g,await this.plugin.saveSettings())})).addExtraButton(m=>m.setIcon("cross").setTooltip("Remove marker set").onClick(async()=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers.splice(a,1),await this.plugin.saveSettings(),this.display())}))}),new L.Setting(o).addButton(n=>n.setButtonText("Add Marker Set").setCta().onClick(async()=>{this.plugin.settings.additionalMarkers||(this.plugin.settings.additionalMarkers=[]),this.plugin.settings.additionalMarkers.push({start:"",end:"",registerCommand:!1}),await this.plugin.saveSettings(),this.display()}))}};function G(c){return c.replace(/\s+/g," ").trim()}function z(c,o){let e=o.indexOf(c);if(e!==-1)return{idx:e,full:!0};for(let n=c.length-1;n>0;n--){if(o.includes(c.slice(0,n)))return{idx:o.indexOf(c.slice(0,n)),full:!1,partial:c.slice(0,n)};if(o.includes(c.slice(-n)))return{idx:o.indexOf(c.slice(-n)),full:!1,partial:c.slice(-n)}}return{idx:-1,full:!1}}function H(c,o){let e=/[\p{L}\p{N}_]+/gu,n;for(;(n=e.exec(c))!==null;)if(o>=n.index&&o<=n.index+n[0].length)return{start:n.index,end:n.index+n[0].length};return null}function J(c){let o=c.getSelection();if(o)return{from:c.getCursor("from"),to:c.getCursor("to"),selection:o};{let e=c.getCursor();return{from:{line:e.line,ch:e.ch},to:{line:e.line,ch:e.ch},selection:""}}}function p(...c){console.log("[CustomComment DEV]",...c)}var V=class extends K.Plugin{constructor(){super(...arguments);this._markerCommandIds=[];this._cleanupGuard=!1}async onload(){p("Plugin loading..."),await this.loadSettings(),this.addSettingTab(new B(this.app,this)),this.addCommand({id:"reload-marker-commands",name:"Reload Marker Commands",callback:()=>this.registerMarkerCommands(!0)}),this.registerMarkerCommands()}registerMarkerCommands(e=!1){e&&this._markerCommandIds&&(this._markerCommandIds=[]),this._markerCommandIds=[];let n=this.settings.template??"%% {cursor} %%",a=n.indexOf("{cursor}"),k="%%",m="%%";a!==-1&&(k=n.slice(0,a).trim()||"%%",m=n.slice(a+8).trim()||"%%");let g="toggle-comment-template";this.addCommand({id:g,name:`Toggle Comment: (${k}|${m})`,editorCallback:t=>this.toggleComment(t)}),this._markerCommandIds.push(g),Array.isArray(this.settings.additionalMarkers)&&this.settings.additionalMarkers.forEach((t,i)=>{if(t&&t.registerCommand){let C=`toggle-comment-marker-set-${i+1}`;this.addCommand({id:C,name:(()=>{let h=t.start?.trim()||"%%",E=t.end?.trim()||"%%";return`Toggle Marker ${i+1}: (${h}|${E})`})(),checkCallback:(h,E)=>(!h&&E&&this.toggleComment(E,t),!0)}),this._markerCommandIds.push(C)}}),p("Marker commands registered:",this._markerCommandIds)}async loadSettings(){this.settings=Object.assign({},q,await this.loadData()),p("Settings loaded:",this.settings)}async saveSettings(){await this.saveData(this.settings),p("Settings saved:",this.settings)}async reloadPlugin(){await this.app.plugins.disablePlugin(this.manifest.id),await this.app.plugins.enablePlugin(this.manifest.id),p("Plugin reloaded")}insertComment(e){let n=this.settings.template,a=n.indexOf("{cursor}");if(a===-1){e.replaceSelection(n),p("Inserted template (no cursor placeholder)");return}let k=n.slice(0,a).trim(),m=n.slice(a+8).trim(),g=`${k} ${m}`.replace(/\s+/g," ").trim(),t=e.getCursor();e.replaceSelection(`${k}  ${m}`.replace(/\s+/g," ").replace(" "," {cursor} "));let i=k.split(`
`),C=i.length-1,h=i[i.length-1].length+1;e.setCursor({line:t.line+C,ch:(C?0:t.ch)+h}),p("Inserted comment at cursor")}toggleComment(e,n){p("toggleComment called",{selection:e.getSelection(),cursor:e.getCursor(),markerSet:n});let a,k;if(n)a=n.start.trim(),k=n.end.trim();else{let s=this.settings.template,l=s.indexOf("{cursor}"),r=s,M="";l!==-1&&(r=s.slice(0,l),M=s.slice(l+8)),a=r.trim(),k=M.trim()}let m=G(a),g=G(k),{from:t,to:i,selection:C}=J(e),h=e.getCursor(),E=e.getLine(h.line),w,d=null;C?w=C:(d=H(E,h.ch),d&&h.ch>d.start&&h.ch<d.end?(w=E.slice(d.start,d.end),t.line=h.line,t.ch=d.start,i.line=h.line,i.ch=d.end):w="");let D=-1,F=-1,y="",Q=!1,I=m,_=g,he=!!(I&&_&&I!==_);p("[Detection] selection:",C),p("[Detection] text:",w);let X=z(m,w),Y=z(g,w);p("[Detection] foundStart:",X),p("[Detection] foundEnd:",Y);let R=[],P=[],Z=e.lineCount();for(let s=0;s<Z;s++){let l=e.getLine(s),r=0;for(;(r=l.indexOf(m,r))!==-1;)R.push({line:s,ch:r}),r+=m.length;for(r=0;(r=l.indexOf(g,r))!==-1;)P.push({line:s,ch:r}),r+=g.length}let A=null,$=[];for(let s=0,l=0,r=0;s<R.length+P.length;){let M=l<R.length?R[l]:null,x=r<P.length?P[r]:null,S=!1;if(M&&(!x||M.line<x.line||M.line===x.line&&M.ch<x.ch))$.push(M),l++,S=!0;else if(x){if($.length>0){let u=$.pop();if(u){let T=x,f={line:u.line,ch:u.ch},b={line:T.line,ch:T.ch+g.length},v=t,O=i,ne=(v.line<b.line||v.line===b.line&&v.ch<b.ch)&&(O.line>f.line||O.line===f.line&&O.ch>f.ch),ie=O.line<f.line||O.line===f.line&&O.ch<=f.ch,se=v.line>b.line||v.line===b.line&&v.ch>=b.ch;if(ne&&!ie&&!se){A={start:u,end:T};break}}}r++}else break}if(A){let{start:s,end:l}=A,r=0;e.getLine(s.line)[s.ch+m.length]===" "&&(r=1);let x=0,S=e.getLine(l.line);l.ch>0&&S[l.ch-1]===" "&&(x=1);let u=0,T=0;s.line===t.line&&s.ch<t.ch&&(u+=m.length+r),l.line===t.line&&l.ch<t.ch&&(u+=g.length+x),s.line===i.line&&s.ch<i.ch&&(T+=m.length+r),l.line===i.line&&l.ch<i.ch&&(T+=g.length+x),e.transaction({changes:[{from:{line:l.line,ch:l.ch-x},to:{line:l.line,ch:l.ch+g.length},text:""},{from:{line:s.line,ch:s.ch},to:{line:s.line,ch:s.ch+m.length+r},text:""}]});let f={...t},b={...i};u&&f.line===t.line&&(f.ch=Math.max(0,f.ch-u)),T&&b.line===i.line&&(b.ch=Math.max(f.ch,b.ch-T)),p("Uncommented marker pair encompassing selection",{from:t,to:i,pairToRemove:A,removedBeforeStart:u,removedBeforeEnd:T,selFrom:f,selTo:b}),t.line===i.line&&t.ch===i.ch?e.setCursor(f):e.setSelection(f,b);return}let ee=e.getRange(t,i),j=m+" "+ee+" "+g;e.replaceRange(j,t,i);let W=m.length+1;if(t.line===i.line&&t.ch===i.ch){let s=t.ch+W;e.setCursor({line:t.line,ch:s})}else{let s={line:t.line,ch:t.ch+W},l;t.line===i.line?l={line:i.line,ch:i.ch+W}:l={line:i.line,ch:i.ch},e.setSelection(s,l)}p("Commented region (no marker pair found)",{from:t,to:i,commented:j});return;function te(s){let l=e.getValue().split(`
`),r=Math.max(0,Math.min(s.line,l.length-1)),M=Math.max(0,Math.min(s.ch,l[r]?.length??0));return{line:r,ch:M}}}toggleCommentAtCursor(e){let n=this.settings.template,a=n.indexOf("{cursor}"),k=n,m="";a!==-1&&(k=n.slice(0,a),m=n.slice(a+8));let g=k.trim(),t=m.trim(),i=e.getCursor(),C=e.getLine(i.line),h=C.indexOf(g),E=t?C.lastIndexOf(t):-1,w=!1;if(g&&t?w=h!==-1&&E!==-1&&i.ch>=h+g.length&&i.ch<=E+t.length:g&&(w=h!==-1&&i.ch>=h+g.length),w){let d=C;g&&(d=d.replace(g,"")),t&&(d=d.replace(t,"")),d=d.trim(),e.setLine(i.line,d)}}};
//# sourceMappingURL=main.js.map
