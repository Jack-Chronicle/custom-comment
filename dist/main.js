"use strict";var Z=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var ce=Object.prototype.hasOwnProperty;var he=(R,W)=>{for(var l in W)Z(R,l,{get:W[l],enumerable:!0})},de=(R,W,l,g)=>{if(W&&typeof W=="object"||typeof W=="function")for(let h of oe(W))!ce.call(R,h)&&h!==l&&Z(R,h,{get:()=>W[h],enumerable:!(g=ae(W,h))||g.enumerable});return R};var fe=R=>de(Z({},"__esModule",{value:!0}),R);var ge={};he(ge,{default:()=>J});module.exports=fe(ge);var se=require("obsidian");var ne={template:"%% {cursor} %%",wordOnlyMode:!1,additionalMarkers:[]};var G=require("obsidian"),H=class extends G.PluginSettingTab{constructor(W,l){super(W,l),this.plugin=l}display(){let{containerEl:W}=this;W.empty(),new G.Setting(W).setName("Comment Format").setDesc("Use {cursor} wherever you want the cursor to go (e.g. '%% {cursor} %%' or '<!-- {cursor} -->').").addText(g=>g.setValue(this.plugin.settings.template).onChange(async h=>{this.plugin.settings.template=h||"%% {cursor} %%",await this.plugin.saveSettings()})),new G.Setting(W).setName("Word-only toggle mode").setDesc("If enabled, toggling will un/comment the word at the cursor's location rather than inserting a comment at the cursor position.").addToggle(g=>g.setValue(!!this.plugin.settings.wordOnlyMode).onChange(async h=>{this.plugin.settings.wordOnlyMode=h,await this.plugin.saveSettings()})),W.createEl("h3",{text:"Additional Marker Sets"}),(this.plugin.settings.additionalMarkers||[]).forEach((g,h)=>{let n=new G.Setting(W).setName(`Marker Set ${h+1}`).addToggle(s=>s.setValue(!!g.registerCommand).onChange(async w=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[h].registerCommand=w,await this.plugin.saveSettings(),this.plugin.registerMarkerCommands(!0),this.display())})).addText(s=>s.setPlaceholder("Start marker").setValue(g.start).onChange(async w=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[h].start=w,await this.plugin.saveSettings())})).addText(s=>s.setPlaceholder("End marker").setValue(g.end).onChange(async w=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[h].end=w,await this.plugin.saveSettings())})).addExtraButton(s=>s.setIcon("cross").setTooltip("Remove marker set").onClick(async()=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers.splice(h,1),await this.plugin.saveSettings(),this.display())}))}),new G.Setting(W).addButton(g=>g.setButtonText("Add Marker Set").setCta().onClick(async()=>{this.plugin.settings.additionalMarkers||(this.plugin.settings.additionalMarkers=[]),this.plugin.settings.additionalMarkers.push({start:"",end:"",registerCommand:!1}),await this.plugin.saveSettings(),this.display()}))}};function P(...R){console.log("[CustomComment DEV]",...R)}var z=[{start:"%%",end:"%%"},{start:"<!--",end:"-->"},{start:"//",end:""}],J=class extends se.Plugin{constructor(){super(...arguments);this._markerCommandIds=[];this._cleanupGuard=!1}async onload(){P("Plugin loading..."),await this.loadSettings(),this.addSettingTab(new H(this.app,this)),this.addCommand({id:"reload-marker-commands",name:"Reload Marker Commands",callback:()=>this.registerMarkerCommands(!0)}),this.registerMarkerCommands()}registerMarkerCommands(l=!1){l&&this._markerCommandIds&&(this._markerCommandIds=[]),this._markerCommandIds=[];let g=this.settings.template??"%% {cursor} %%",h=g.indexOf("{cursor}"),n="%%",s="%%";h!==-1&&(n=g.slice(0,h).trim()||"%%",s=g.slice(h+8).trim()||"%%");let w="toggle-comment-template";this.addCommand({id:w,name:`Toggle Comment: (${n}|${s})`,editorCallback:O=>this.toggleComment(O)}),this._markerCommandIds.push(w),Array.isArray(this.settings.additionalMarkers)&&this.settings.additionalMarkers.forEach((O,u)=>{if(O&&O.registerCommand){let o=`toggle-comment-marker-set-${u+1}`;this.addCommand({id:o,name:(()=>{let p=O.start?.trim()||"%%",a=O.end?.trim()||"%%";return`Toggle Marker ${u+1}: (${p}|${a})`})(),checkCallback:(p,a)=>(!p&&a&&this.toggleComment(a,O),!0)}),this._markerCommandIds.push(o)}}),P("Marker commands registered:",this._markerCommandIds)}async loadSettings(){this.settings=Object.assign({},ne,await this.loadData()),P("Settings loaded:",this.settings)}async saveSettings(){await this.saveData(this.settings),P("Settings saved:",this.settings)}async reloadPlugin(){await this.app.plugins.disablePlugin(this.manifest.id),await this.app.plugins.enablePlugin(this.manifest.id),P("Plugin reloaded")}insertComment(l){let g=this.settings.template,h=g.indexOf("{cursor}");if(h===-1){l.replaceSelection(g),P("Inserted template (no cursor placeholder)");return}let n=g.slice(0,h).trim(),s=g.slice(h+8).trim(),w=`${n} ${s}`.replace(/\s+/g," ").trim(),O=l.getCursor();l.replaceSelection(`${n}  ${s}`.replace(/\s+/g," ").replace(" "," {cursor} "));let u=n.split(`
`),o=u.length-1,p=u[u.length-1].length+1;l.setCursor({line:O.line+o,ch:(o?0:O.ch)+p}),P("Inserted comment at cursor")}toggleComment(l,g){P("toggleComment called",{selection:l.getSelection(),cursor:l.getCursor(),markerSet:g});function h(e){let t=l.getValue().split(`
`),i=Math.max(0,Math.min(e.line,t.length-1)),r=Math.max(0,Math.min(e.ch,t[i]?.length??0));return{line:i,ch:r}}let n,s,w,O;if(g)n=g.start.trim(),s=g.end.trim(),w=g.start.endsWith(" ")?g.start:g.start+" ",O=g.end.startsWith(" ")?g.end:" "+g.end;else{let e=this.settings.template,t=e.indexOf("{cursor}"),i=e,r="";t!==-1&&(i=e.slice(0,t),r=e.slice(t+8)),n=i.trim(),s=r.trim(),w=n+(n&&!n.endsWith(" ")?" ":""),O=(s&&!s.startsWith(" ")?" ":"")+s}let u=l.getSelection(),o=l.getCursor(),p,a=l.getCursor("from"),C=l.getCursor("to"),m=null,E=l.getLine(o.line);function ie(e,t){let i=/[\p{L}\p{N}_]+/gu,r;for(;(r=i.exec(e))!==null;)if(t>=r.index&&t<=r.index+r[0].length)return{start:r.index,end:r.index+r[0].length};return null}function ee(e,t,i){return t?i?e.startsWith(t)&&e.endsWith(i):e.startsWith(t):!1}function B(e,t,i,r,I,F){let L=r.trim(),V=I.trim();if(F==="back")for(let d=t;d>=0;d--){let c=e[d],f=d===t?i:c.length;for(let x=f-1;x>=0;x--){if(c.substr(x,L.length)===L)return{type:"marker",pos:{line:d,ch:x}};if(c.substr(x,V.length)===V)return{type:"opposite",pos:{line:d,ch:x}}}}else for(let d=t;d<e.length;d++){let c=e[d],f=d===t?i:0;for(let x=f;x<=c.length-Math.min(L.length,V.length);x++){if(c.substr(x,L.length)===L)return{type:"marker",pos:{line:d,ch:x}};if(c.substr(x,V.length)===V)return{type:"opposite",pos:{line:d,ch:x}}}}return{type:null,pos:null}}let A=!1,b=null,M=null,y=l.getValue().split(`
`);if(n&&s){let e,t;if(u){let i=B(y,a.line,a.ch,n,s,"back"),r=B(y,C.line,C.ch,s,n,"forward");e=i.type,t=r.type,e==="marker"&&(b=i.pos),t==="marker"&&(M=r.pos)}else{let i=B(y,o.line,o.ch,n,s,"back"),r=B(y,o.line,o.ch,s,n,"forward");e=i.type,t=r.type,e==="marker"&&(b=i.pos),t==="marker"&&(M=r.pos)}e==="marker"&&t==="marker"?A=!0:A=!1}if(P("comment:",A,{start:b?{line:b.line+1,ch:b.ch+1}:null,end:M?{line:M.line+1,ch:M.ch+1}:null}),u&&n&&s){let L=function(c,f){if(!f)return!1;for(let x=1;x<=f.length;x++)if(c.includes(f.slice(0,x))||c.includes(f.slice(-x)))return!0;return!1};var re=L;let e=l.getLine(a.line),t=u,i=!1,r=!1,I=t.indexOf(n),F=t.indexOf(s);if(!i&&L(t,n)){let c=e.slice(Math.max(0,a.ch-n.length),a.ch+t.length);c.includes(n)&&(i=!0,I=c.indexOf(n)-(a.ch-Math.max(0,a.ch-n.length)))}if(!r&&L(t,s)){let c=e.slice(a.ch,Math.min(e.length,C.ch+s.length));c.includes(s)&&(r=!0,F=c.indexOf(s))}if(t.includes(n)&&(i=!0,I=t.indexOf(n)),t.includes(s)&&(r=!0,F=t.indexOf(s)),n===s&&n.length>0&&(i||r)){let c=B(y,a.line,a.ch,n,"","back"),f=B(y,C.line,C.ch,s,"","forward");c.type==="marker"&&(b=c.pos),f.type==="marker"&&(M=f.pos),b&&M&&(A=!0)}else if(i&&!r){let c=a.line,f=e.indexOf(n,a.ch);f===-1&&(f=a.ch);let x=!1;for(let k=c;k<y.length;k++){let $=y[k],Y=k===c?f+n.length:0;for(let _=Y;_<=$.length-s.length;_++){if($.substr(_,s.length)===s){b={line:c,ch:f},M={line:k,ch:_},A=!0,x=!0;break}if($.substr(_,n.length)===n&&(k!==c||_!==f)){P("Stopped search for end marker: found another start marker first",{from:{line:c,ch:f},at:{line:k,ch:_}}),x=!0;break}}if(x)break}}else if(r&&!i){let c=C.line,f=e.indexOf(s,a.ch);f===-1&&(f=C.ch);let x=!1;for(let k=c;k>=0;k--){let $=y[k],Y=k===c?f-1:$.length-1;for(let _=Y;_>=0;_--){if($.substr(_,n.length)===n){b={line:k,ch:_},M={line:c,ch:f},A=!0,x=!0;break}if($.substr(_,s.length)===s&&(k!==c||_!==f)){P("Stopped search for start marker: found another end marker first",{from:{line:c,ch:f},at:{line:k,ch:_}}),x=!0;break}}if(x)break}}let V=a.ch<=n.length&&e.slice(0,n.length).startsWith(n),d=C.ch>=e.length-s.length&&e.slice(-s.length).endsWith(s);if(!V&&!d)return}if(u&&n&&s){let L=function(d,c){if(!c)return!1;for(let f=1;f<=c.length;f++)if(d.includes(c.slice(0,f))||d.includes(c.slice(-f)))return!0;return!1};var re=L;let e=l.getLine(a.line),t=u,i=!1,r=!1,I=t.indexOf(n),F=t.indexOf(s);if(!i&&L(t,n)){let d=e.slice(Math.max(0,a.ch-n.length),a.ch+t.length);d.includes(n)&&(i=!0,I=d.indexOf(n)-(a.ch-Math.max(0,a.ch-n.length)))}if(!r&&L(t,s)){let d=e.slice(a.ch,Math.min(e.length,C.ch+s.length));d.includes(s)&&(r=!0,F=d.indexOf(s))}if(t.includes(n)&&(i=!0,I=t.indexOf(n)),t.includes(s)&&(r=!0,F=t.indexOf(s)),n===s&&n.length>0&&(i||r)){let d=B(y,a.line,a.ch,n,"","back"),c=B(y,C.line,C.ch,s,"","forward");d.type==="marker"&&(b=d.pos),c.type==="marker"&&(M=c.pos),b&&M&&(A=!0)}else if(i){let d=B(y,C.line,C.ch,s,n,"forward");d.type==="marker"&&(M=d.pos);let c=a.line,f=e.indexOf(n,a.ch);f!==-1&&(b={line:c,ch:f}),b&&M&&(A=!0)}else if(r){let d=B(y,a.line,a.ch,n,s,"back");d.type==="marker"&&(b=d.pos);let c=C.line,f=e.indexOf(s,a.ch);f!==-1&&(M={line:c,ch:f}),b&&M&&(A=!0)}}if(A&&b&&M){let e=y[b.line],t=n+" ";y[b.line]=e.slice(0,b.ch)+e.slice(b.ch+t.length);let i=M.line,r=M.ch;if(b.line===M.line){r-=t.length;let k=y[i],$=" "+s;if(r=k.indexOf($,r),r===-1&&(r=k.indexOf(s,r),r>0&&k[r-1]===" "&&(r=r-1)),r===-1)return;y[i]=k.slice(0,r)+k.slice(r+$.length)}else{let k=y[i],$=" "+s;y[i]=k.slice(0,r)+k.slice(r+$.length)}let I=Math.min(b.line,M.line),F=Math.max(b.line,M.line),L=y.slice(I,F+1).join(`
`);l.replaceRange(L,{line:I,ch:0},{line:F,ch:l.getLine(F).length});let V=a.line,d=a.ch-t.length;d<0&&(d=0);let c=y.length-1;V>c&&(V=c);let f=y[V]?.length??0;d>f&&(d=f);let x=h({line:V,ch:d});l.setCursor(x);return}let D=!1;m=ie(E,o.ch),u?D=!1:m&&(o.ch>m.start&&o.ch<m.end||this.settings.wordOnlyMode&&(o.ch===m.start||o.ch===m.end)?D=!0:D=!1),P("Mode:",u?"selection":D?"word":"insert",{selection:u,wordBounds:m,useWord:D}),u?p=u:D&&m?(p=E.slice(m.start,m.end),a={line:o.line,ch:m.start},C={line:o.line,ch:m.end}):(p="",a={line:o.line,ch:o.ch},C={line:o.line,ch:o.ch});let S=n,T=s,v=!1,N=p;if(u){if(S&&T&&u.startsWith(S)&&u.endsWith(T))v=!0,N=u;else for(let e of z)if(e.start&&e.end&&u.startsWith(e.start)&&u.endsWith(e.end)){S=e.start,T=e.end,v=!0,N=u;break}if(!v){let e=l.getLine(a.line),t=l.getLine(C.line);if(S&&T&&e.startsWith(S)&&t.endsWith(T))v=!0,N=l.getRange({line:a.line,ch:0},{line:C.line,ch:l.getLine(C.line).length});else for(let i of z)if(i.start&&i.end&&e.startsWith(i.start)&&t.endsWith(i.end)){S=i.start,T=i.end,v=!0,N=l.getRange({line:a.line,ch:0},{line:C.line,ch:l.getLine(C.line).length});break}}}else if(D&&m){if(S&&T&&E.startsWith(S)&&E.endsWith(T))v=!0,N=E;else for(let e of z)if(e.start&&e.end&&E.startsWith(e.start)&&E.endsWith(e.end)){S=e.start,T=e.end,v=!0,N=E;break}if(!v&&S&&T&&p.startsWith(S)&&p.endsWith(T))v=!0,N=p;else if(!v){for(let e of z)if(e.start&&e.end&&p.startsWith(e.start)&&p.endsWith(e.end)){S=e.start,T=e.end,v=!0,N=p;break}}}else if(S&&T&&E.startsWith(S)&&E.endsWith(T))v=!0,N=E;else for(let e of z)if(e.start&&e.end&&E.startsWith(e.start)&&E.endsWith(e.end)){S=e.start,T=e.end,v=!0,N=E;break}function ue(e,t,i,r,I){return{result:e,newStart:r,newEnd:I}}if(v){if(u&&S&&N===S){let e=l.getLine(a.line),t=e.indexOf(S),i=T?e.indexOf(T,t+S.length):-1;if(i!==-1){let r=e.slice(t+S.length,i);if(/^\s*$/.test(r)){P("Deleting end marker after deleting start marker",{line:a.line,startIdx:t,endIdx:i,removalUsedStart:S,removalUsedEnd:T});let I=e.slice(0,t),F=e.slice(i+T.length);l.setLine(a.line,I+F),l.setCursor({line:a.line,ch:t});return}}}return}let K=n,te=s,j=!1,q=p;if(u?q=p:D&&m?q=E.slice(m.start,m.end):q=p,K&&ee(q,K,te))j=!0;else for(let e of z)if(e.start&&ee(q,e.start,e.end)){K=e.start,te=e.end,j=!0;break}function le(e){return n+" "+e+" "+s}function Q(e){let t=n+" ",i=" "+s;return e.startsWith(t)&&e.endsWith(i)?e.slice(t.length,e.length-i.length):e.startsWith(n)&&e.endsWith(s)?e.slice(n.length,e.length-s.length).trim():null}let U=null;if(u)U=Q(p),U!==null&&(j=!0);else if(D&&m){let e=E.slice(m.start,m.end);U=Q(e),U!==null&&(j=!0)}else U=Q(p),U!==null&&(j=!0);if(j){let e=U!==null?U:p;if(u){l.replaceSelection(e);let t=h(a),i=h({line:C.line,ch:a.ch+e.length});l.setSelection(t,i)}else if(D&&m){l.replaceRange(e,{line:o.line,ch:m.start},{line:o.line,ch:m.end});let t=m.start+e.length,i=h({line:o.line,ch:t});l.setCursor(i)}else{l.replaceRange(e,{line:o.line,ch:o.ch},{line:o.line,ch:o.ch});let t=h({line:o.line,ch:o.ch});l.setCursor(t)}}else{let e=p.trim(),t;if(!u&&!e?t=n+"  "+s:t=le(e),!u&&!e){l.replaceRange(t,{line:o.line,ch:o.ch},{line:o.line,ch:o.ch});let i=o.ch+(n+" ").length,r=h({line:o.line,ch:i});l.setCursor(r)}else if(u){l.replaceSelection(t);let i=(n+" ").length,r=h({line:a.line,ch:a.ch+i}),I=h({line:C.line,ch:a.ch+i+e.length});l.setSelection(r,I)}else if(D&&m){l.replaceRange(t,{line:o.line,ch:m.start},{line:o.line,ch:m.end});let i=m.start+(n+" ").length,r=h({line:o.line,ch:i});l.setCursor(r)}else{l.replaceRange(t,{line:o.line,ch:o.ch},{line:o.line,ch:o.ch});let i=h({line:o.line,ch:o.ch+(n+" ").length});l.setCursor(i)}}let X=h(l.getCursor());(X.line!==l.getCursor().line||X.ch!==l.getCursor().ch)&&l.setCursor(X)}toggleCommentAtCursor(l){let g=this.settings.template,h=g.indexOf("{cursor}"),n=g,s="";h!==-1&&(n=g.slice(0,h),s=g.slice(h+8));let w=n.trim(),O=s.trim(),u=l.getCursor(),o=l.getLine(u.line),p=o.indexOf(w),a=O?o.lastIndexOf(O):-1,C=!1;if(w&&O?C=p!==-1&&a!==-1&&u.ch>=p+w.length&&u.ch<=a:w&&(C=p!==-1&&u.ch>=p+w.length),C){let m=o;w&&(m=m.replace(w,"")),O&&(m=m.replace(O,"")),m=m.trim(),l.setLine(u.line,m)}}};
//# sourceMappingURL=main.js.map
