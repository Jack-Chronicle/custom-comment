"use strict";var K=Object.defineProperty;var le=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var ae=Object.prototype.hasOwnProperty;var oe=(T,C)=>{for(var i in C)K(T,i,{get:C[i],enumerable:!0})},ce=(T,C,i,h)=>{if(C&&typeof C=="object"||typeof C=="function")for(let d of re(C))!ae.call(T,d)&&d!==i&&K(T,d,{get:()=>C[d],enumerable:!(h=le(C,d))||h.enumerable});return T};var he=T=>ce(K({},"__esModule",{value:!0}),T);var ge={};oe(ge,{default:()=>z});module.exports=he(ge);var X=require("obsidian");var Q={template:"%% {cursor} %%",wordOnlyMode:!1,additionalMarkers:[]};var V=require("obsidian"),q=class extends V.PluginSettingTab{constructor(C,i){super(C,i),this.plugin=i}display(){let{containerEl:C}=this;C.empty(),new V.Setting(C).setName("Comment Format").setDesc("Use {cursor} wherever you want the cursor to go (e.g. '%% {cursor} %%' or '<!-- {cursor} -->').").addText(h=>h.setValue(this.plugin.settings.template).onChange(async d=>{this.plugin.settings.template=d||"%% {cursor} %%",await this.plugin.saveSettings()})),new V.Setting(C).setName("Word-only toggle mode").setDesc("If enabled, toggling will un/comment the word at the cursor's location rather than inserting a comment at the cursor position.").addToggle(h=>h.setValue(!!this.plugin.settings.wordOnlyMode).onChange(async d=>{this.plugin.settings.wordOnlyMode=d,await this.plugin.saveSettings()})),C.createEl("h3",{text:"Additional Marker Sets"}),(this.plugin.settings.additionalMarkers||[]).forEach((h,d)=>{let E=new V.Setting(C).setName(`Marker Set ${d+1}`).addToggle(p=>p.setValue(!!h.registerCommand).onChange(async g=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[d].registerCommand=g,await this.plugin.saveSettings(),this.plugin.registerMarkerCommands(!0),this.display())})).addText(p=>p.setPlaceholder("Start marker").setValue(h.start).onChange(async g=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[d].start=g,await this.plugin.saveSettings())})).addText(p=>p.setPlaceholder("End marker").setValue(h.end).onChange(async g=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[d].end=g,await this.plugin.saveSettings())})).addExtraButton(p=>p.setIcon("cross").setTooltip("Remove marker set").onClick(async()=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers.splice(d,1),await this.plugin.saveSettings(),this.display())}))}),new V.Setting(C).addButton(h=>h.setButtonText("Add Marker Set").setCta().onClick(async()=>{this.plugin.settings.additionalMarkers||(this.plugin.settings.additionalMarkers=[]),this.plugin.settings.additionalMarkers.push({start:"",end:"",registerCommand:!1}),await this.plugin.saveSettings(),this.display()}))}};function S(...T){console.log("[CustomComment DEV]",...T)}var de=[{start:"%%",end:"%%"},{start:"<!--",end:"-->"},{start:"//",end:""}],z=class extends X.Plugin{constructor(){super(...arguments);this._markerCommandIds=[];this._cleanupGuard=!1}async onload(){S("Plugin loading..."),await this.loadSettings(),this.addSettingTab(new q(this.app,this)),this.addCommand({id:"reload-marker-commands",name:"Reload Marker Commands",callback:()=>this.registerMarkerCommands(!0)}),this.registerMarkerCommands()}registerMarkerCommands(i=!1){i&&this._markerCommandIds&&(this._markerCommandIds=[]),this._markerCommandIds=[];let h=this.settings.template??"%% {cursor} %%",d=h.indexOf("{cursor}"),E="%%",p="%%";d!==-1&&(E=h.slice(0,d).trim()||"%%",p=h.slice(d+8).trim()||"%%");let g="toggle-comment-template";this.addCommand({id:g,name:`Toggle Comment: (${E}|${p})`,editorCallback:m=>this.toggleComment(m)}),this._markerCommandIds.push(g),Array.isArray(this.settings.additionalMarkers)&&this.settings.additionalMarkers.forEach((m,M)=>{if(m&&m.registerCommand){let O=`toggle-comment-marker-set-${M+1}`;this.addCommand({id:O,name:(()=>{let I=m.start?.trim()||"%%",_=m.end?.trim()||"%%";return`Toggle Marker ${M+1}: (${I}|${_})`})(),checkCallback:(I,_)=>(!I&&_&&this.toggleComment(_,m),!0)}),this._markerCommandIds.push(O)}}),S("Marker commands registered:",this._markerCommandIds)}async loadSettings(){this.settings=Object.assign({},Q,await this.loadData()),S("Settings loaded:",this.settings)}async saveSettings(){await this.saveData(this.settings),S("Settings saved:",this.settings)}async reloadPlugin(){await this.app.plugins.disablePlugin(this.manifest.id),await this.app.plugins.enablePlugin(this.manifest.id),S("Plugin reloaded")}insertComment(i){let h=this.settings.template,d=h.indexOf("{cursor}");if(d===-1){i.replaceSelection(h),S("Inserted template (no cursor placeholder)");return}let E=h.slice(0,d).trim(),p=h.slice(d+8).trim(),g=`${E} ${p}`.replace(/\s+/g," ").trim(),m=i.getCursor();i.replaceSelection(`${E}  ${p}`.replace(/\s+/g," ").replace(" "," {cursor} "));let M=E.split(`
`),O=M.length-1,I=M[M.length-1].length+1;i.setCursor({line:m.line+O,ch:(O?0:m.ch)+I}),S("Inserted comment at cursor")}toggleComment(i,h){S("toggleComment called",{selection:i.getSelection(),cursor:i.getCursor(),markerSet:h});let d,E;if(h)d=h.start.trim(),E=h.end.trim();else{let t=this.settings.template,s=t.indexOf("{cursor}"),c=t,r="";s!==-1&&(c=t.slice(0,s),r=t.slice(s+8)),d=c.trim(),E=r.trim()}function p(t){return t.replace(/\s+/g," ").trim()}let g=p(d),m=p(E);function M(t,s){let c=s.indexOf(t);if(c!==-1)return{idx:c,full:!0};for(let r=t.length-1;r>0;r--){if(s.includes(t.slice(0,r)))return{idx:s.indexOf(t.slice(0,r)),full:!1,partial:t.slice(0,r)};if(s.includes(t.slice(-r)))return{idx:s.indexOf(t.slice(-r)),full:!1,partial:t.slice(-r)}}return{idx:-1,full:!1}}function O({line:t,marker:s,partialIdx:c,isStart:r,otherMarker:v,uniqueMarkers:e=!0}){let n=s.length,a=-1;for(let u=Math.max(0,c-n+1);u<=c;u++)if(t.slice(u,u+n)===s){a=u;break}if(a===-1){for(let u=c;u<=Math.min(t.length-n,c+n-1);u++)if(t.slice(u,u+n)===s){a=u;break}}if(a===-1)return{confirmed:!1};if(r){let u=t.indexOf(v,a+n);if(u===-1)return{confirmed:!1};if(e){let f=t.indexOf(s,a+n);if(f!==-1&&f<u)return{confirmed:!1}}return{confirmed:!0,startIdx:a,endIdx:u}}else{let u=t.lastIndexOf(v,a-1);if(u===-1)return{confirmed:!1};if(e){let f=t.lastIndexOf(s,a-1);if(f!==-1&&f>u)return{confirmed:!1}}return{confirmed:!0,startIdx:u,endIdx:a}}}function I(t,s,c){return c==="back"?P.lastIndexOf(t,s):P.indexOf(t,s)}function _(t,s,c){let r=t.trim();return s&&c?r.startsWith(s)&&r.endsWith(c):s?r.startsWith(s):!1}function U(t){for(let s of de){let c=p(s.start),r=p(s.end);if(_(t,c,r))return{found:!0,markerStart:s.start,markerEnd:s.end}}return{found:!1}}let b=i.getSelection(),y=i.getCursor(),o=i.getCursor("from"),l=i.getCursor("to"),P=i.getLine(y.line),W,R=null;function Y(t,s){let c=/[\p{L}\p{N}_]+/gu,r;for(;(r=c.exec(t))!==null;)if(s>=r.index&&s<=r.index+r[0].length)return{start:r.index,end:r.index+r[0].length};return null}b?W=b:(R=Y(P,y.ch),R&&y.ch>R.start&&y.ch<R.end?(W=P.slice(R.start,R.end),o={line:y.line,ch:R.start},l={line:y.line,ch:R.end}):(W="",o={line:y.line,ch:y.ch},l={line:y.line,ch:y.ch}));let G=-1,j=-1,D="",Z=!1,A=g,B=m,me=!!(A&&B&&A!==B);S("[Detection] selection:",b),S("[Detection] text:",W);let ee=M(g,W),te=M(m,W);if(S("[Detection] foundStart:",ee),S("[Detection] foundEnd:",te),b){let t=[],s=[],c=i.lineCount();for(let e=0;e<c;e++){let n=i.getLine(e),a=0;for(;(a=n.indexOf(g,a))!==-1;)t.push({line:e,ch:a}),a+=g.length;for(a=0;(a=n.indexOf(m,a))!==-1;)s.push({line:e,ch:a}),a+=m.length}let r=null,v=[];for(let e=0,n=0,a=0;e<t.length+s.length;){let u=n<t.length?t[n]:null,f=a<s.length?s[a]:null,J=!1;if(u&&(!f||u.line<f.line||u.line===f.line&&u.ch<f.ch))v.push(u),n++,J=!0;else if(f){if(v.length>0){let $=v.pop();if($){let N=f,F={line:$.line,ch:$.ch},k={line:N.line,ch:N.ch+m.length},x=o,w=l,L=(x.line<k.line||x.line===k.line&&x.ch<k.ch)&&(w.line>F.line||w.line===F.line&&w.ch>F.ch),ie=w.line<F.line||w.line===F.line&&w.ch<=F.ch,se=x.line>k.line||x.line===k.line&&x.ch>=k.ch;if(L&&!ie&&!se){r={start:$,end:N};break}}}a++}else break}if(r){let{start:e,end:n}=r,a=0;i.getLine(e.line)[e.ch+g.length]===" "&&(a=1);let f=0,J=i.getLine(n.line);n.ch>0&&J[n.ch-1]===" "&&(f=1);let $=0,N=0,F=0;e.line===o.line&&(e.ch<o.ch?$+=g.length+a:e.ch>=o.ch&&e.ch<l.ch&&o.line===l.line&&(F+=g.length+a)),n.line===l.line&&(n.ch<l.ch?N+=m.length+f:n.ch>=o.ch&&n.ch<l.ch&&o.line===l.line&&(F+=m.length+f));let k={},x={};e.line===o.line?e.ch<o.ch?k[e.line]=(k[e.line]||0)+g.length+a:e.ch>=o.ch&&e.ch<l.ch&&o.line===l.line&&(x[e.line]=(x[e.line]||0)+g.length+a):e.line>o.line&&e.line<l.line&&(x[e.line]=(x[e.line]||0)+g.length+a),n.line===l.line?n.ch<l.ch?k[n.line]=(k[n.line]||0)+m.length+f:n.ch>=o.ch&&n.ch<l.ch&&o.line===l.line&&(x[n.line]=(x[n.line]||0)+m.length+f):n.line>o.line&&n.line<l.line&&(x[n.line]=(x[n.line]||0)+m.length+f),i.transaction({changes:[{from:{line:n.line,ch:n.ch-f},to:{line:n.line,ch:n.ch+m.length},text:""},{from:{line:e.line,ch:e.ch},to:{line:e.line,ch:e.ch+g.length+a},text:""}]});let w={...o},L={...l};k[w.line]&&(w.ch=Math.max(0,w.ch-k[w.line])),(k[L.line]||x[L.line])&&(L.ch=Math.max(w.ch,L.ch-(k[L.line]||0)-(x[L.line]||0))),S("Uncommented marker pair encompassing selection",{from:o,to:l,pairToRemove:r,removedBefore:k,removedWithin:x,selFrom:w,selTo:L}),i.setSelection(w,L);return}if(b){let e=i.getRange(o,l),n=g+(e?" ":"")+e+(e?" ":"")+m;i.replaceRange(n,o,l);let a=g.length+(e?1:0),u={line:o.line,ch:o.ch+a},f;o.line===l.line?f={line:l.line,ch:l.ch+a}:f={line:l.line,ch:l.ch},i.setSelection(u,f),S("Commented region (no marker pair found)",{from:o,to:l,commented:n});return}}else return;if(Z){let t=P.slice(0,G),s=P.slice(B&&j!==-1?j+B.length:P.length),c=0;D.startsWith(" ")&&(D=D.slice(1),c=1);let r=0;D.endsWith(" ")&&(D=D.slice(0,-1),r=1);let v=t+D+s;if(i.setLine(y.line,v),b){let e=o.ch,n=l.ch;o.ch<=G+A.length+c?e=G:e=o.ch-A.length+c,B&&j!==-1&&l.ch>=j?n=G+D.length:n=l.ch-A.length+c,e=Math.max(0,e),n=Math.max(e,n);let a={line:y.line,ch:e},u={line:y.line,ch:n};i.setSelection(a,u),S("Uncommented region",{from:o,to:l,region:D})}else return}else if(b){let t=i.getRange(o,l),s=A+(t?" ":"")+t+(t?" ":"")+B;i.replaceRange(s,o,l);let c=A.length+(t?1:0),r=B.length+(t?1:0),v={line:o.line,ch:o.ch+c},e;o.line===l.line?e={line:l.line,ch:l.ch+c}:e={line:l.line,ch:l.ch},i.setSelection(v,e),S("Commented region",{from:o,to:l,commented:s})}else return;function ne(t){let s=i.getValue().split(`
`),c=Math.max(0,Math.min(t.line,s.length-1)),r=Math.max(0,Math.min(t.ch,s[c]?.length??0));return{line:c,ch:r}}let H=ne(i.getCursor());(H.line!==i.getCursor().line||H.ch!==i.getCursor().ch)&&i.setCursor(H)}toggleCommentAtCursor(i){let h=this.settings.template,d=h.indexOf("{cursor}"),E=h,p="";d!==-1&&(E=h.slice(0,d),p=h.slice(d+8));let g=E.trim(),m=p.trim(),M=i.getCursor(),O=i.getLine(M.line),I=O.indexOf(g),_=m?O.lastIndexOf(m):-1,U=!1;if(g&&m?U=I!==-1&&_!==-1&&M.ch>=I+g.length&&M.ch<=_+m.length:g&&(U=I!==-1&&M.ch>=I+g.length),U){let b=O;g&&(b=b.replace(g,"")),m&&(b=b.replace(m,"")),b=b.trim(),i.setLine(M.line,b)}}};
//# sourceMappingURL=main.js.map
