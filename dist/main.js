"use strict";var te=Object.defineProperty;var ae=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var ce=Object.prototype.hasOwnProperty;var he=(R,O)=>{for(var i in O)te(R,i,{get:O[i],enumerable:!0})},de=(R,O,i,f)=>{if(O&&typeof O=="object"||typeof O=="function")for(let c of oe(O))!ce.call(R,c)&&c!==i&&te(R,c,{get:()=>O[c],enumerable:!(f=ae(O,c))||f.enumerable});return R};var fe=R=>de(te({},"__esModule",{value:!0}),R);var ue={};he(ue,{default:()=>Q});module.exports=fe(ue);var ie=require("obsidian");var se={template:"%% {cursor} %%",wordOnlyMode:!1,additionalMarkers:[]};var U=require("obsidian"),K=class extends U.PluginSettingTab{constructor(O,i){super(O,i),this.plugin=i}display(){let{containerEl:O}=this;O.empty(),new U.Setting(O).setName("Comment Format").setDesc("Use {cursor} wherever you want the cursor to go (e.g. '%% {cursor} %%' or '<!-- {cursor} -->').").addText(f=>f.setValue(this.plugin.settings.template).onChange(async c=>{this.plugin.settings.template=c||"%% {cursor} %%",await this.plugin.saveSettings()})),new U.Setting(O).setName("Word-only toggle mode").setDesc("If enabled, toggling will un/comment the word at the cursor's location rather than inserting a comment at the cursor position.").addToggle(f=>f.setValue(!!this.plugin.settings.wordOnlyMode).onChange(async c=>{this.plugin.settings.wordOnlyMode=c,await this.plugin.saveSettings()})),O.createEl("h3",{text:"Additional Marker Sets"}),(this.plugin.settings.additionalMarkers||[]).forEach((f,c)=>{let n=new U.Setting(O).setName(`Marker Set ${c+1}`).addToggle(s=>s.setValue(!!f.registerCommand).onChange(async k=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[c].registerCommand=k,await this.plugin.saveSettings(),this.plugin.registerMarkerCommands(!0),this.display())})).addText(s=>s.setPlaceholder("Start marker").setValue(f.start).onChange(async k=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[c].start=k,await this.plugin.saveSettings())})).addText(s=>s.setPlaceholder("End marker").setValue(f.end).onChange(async k=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers[c].end=k,await this.plugin.saveSettings())})).addExtraButton(s=>s.setIcon("cross").setTooltip("Remove marker set").onClick(async()=>{this.plugin.settings.additionalMarkers&&(this.plugin.settings.additionalMarkers.splice(c,1),await this.plugin.saveSettings(),this.display())}))}),new U.Setting(O).addButton(f=>f.setButtonText("Add Marker Set").setCta().onClick(async()=>{this.plugin.settings.additionalMarkers||(this.plugin.settings.additionalMarkers=[]),this.plugin.settings.additionalMarkers.push({start:"",end:"",registerCommand:!1}),await this.plugin.saveSettings(),this.display()}))}};function z(...R){console.log("[CustomComment DEV]",...R)}var q=[{start:"%%",end:"%%"},{start:"<!--",end:"-->"},{start:"//",end:""}],Q=class extends ie.Plugin{constructor(){super(...arguments);this._markerCommandIds=[];this._cleanupGuard=!1}async onload(){await this.loadSettings(),this.addSettingTab(new K(this.app,this)),this.addCommand({id:"reload-marker-commands",name:"Reload Marker Commands",callback:()=>this.registerMarkerCommands(!0)}),this.registerMarkerCommands(),this.registerEvent(this.app.workspace.on("editor-change",i=>{i&&i.hasFocus&&i.hasFocus()&&this.handleEditorChange(i)}))}handleEditorChange(i){let f=i.getSelection(),c=i.getCursor(),n=i.getCursor("from"),s=i.getCursor("to"),k=i.getLine(c.line),M=this.settings.template,u=M.indexOf("{cursor}"),a=M.slice(0,u),p=M.slice(u+8);function o(d,C,H,G,_){if(!C)return!1;if(G>=0&&G<=C.length&&H.slice(G-C.length,G)===C||_>=0&&_<=H.length&&H.slice(_,_+C.length)===C)return!0;if(d&&C.length>0){for(let I=1;I<C.length;I++)if(d.startsWith(C.slice(0,I))||d.endsWith(C.slice(-I)))return!0}return!1}let x=!1;if(f)x=o(f,a,k,n.ch,s.ch)||o(f,p,k,n.ch,s.ch);else{let d=k.slice(Math.max(0,c.ch-a.length),c.ch),C=k.slice(c.ch,c.ch+p.length);(a&&d&&a.startsWith(d)&&d.length<a.length&&c.ch<=a.length||p&&C&&p.endsWith(C)&&C.length<p.length&&c.ch>=k.length-p.length)&&(x=!0)}if(x){if(this._cleanupGuard)return;this._cleanupGuard=!0;try{this.toggleComment(i)}finally{this._cleanupGuard=!1}}}registerMarkerCommands(i=!1){i&&this._markerCommandIds&&(this._markerCommandIds=[]),this._markerCommandIds=[];let f=this.settings.template??"%% {cursor} %%",c=f.indexOf("{cursor}"),n="%%",s="%%";c!==-1&&(n=f.slice(0,c).trim()||"%%",s=f.slice(c+8).trim()||"%%",n=n,s=s);let k="toggle-comment-template";this.addCommand({id:k,name:`Toggle Comment: (${n}|${s})`,editorCallback:M=>this.toggleComment(M)}),this._markerCommandIds.push(k),Array.isArray(this.settings.additionalMarkers)&&this.settings.additionalMarkers.forEach((M,u)=>{if(M&&M.registerCommand){let a=`toggle-comment-marker-set-${u+1}`;this.addCommand({id:a,name:(()=>{let p=M.start?.trim()||"%%",o=M.end?.trim()||"%%";return`Toggle Marker ${u+1}: (${p}|${o})`})(),checkCallback:(p,o)=>(!p&&o&&this.toggleComment(o,M),!0)}),this._markerCommandIds.push(a)}})}async loadSettings(){this.settings=Object.assign({},se,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async reloadPlugin(){await this.app.plugins.disablePlugin(this.manifest.id),await this.app.plugins.enablePlugin(this.manifest.id)}insertComment(i){let f=this.settings.template,c=f.indexOf("{cursor}");if(c===-1){i.replaceSelection(f);return}let n=f.slice(0,c).trim(),s=f.slice(c+8).trim(),k=`${n} ${s}`.replace(/\s+/g," ").trim(),M=i.getCursor();i.replaceSelection(`${n}  ${s}`.replace(/\s+/g," ").replace(" "," {cursor} "));let u=n.split(`
`),a=u.length-1,p=u[u.length-1].length+1;i.setCursor({line:M.line+a,ch:(a?0:M.ch)+p})}toggleComment(i,f){z("toggleComment called",{selection:i.getSelection(),cursor:i.getCursor(),markerSet:f});function c(e){let t=i.getValue().split(`
`),l=Math.max(0,Math.min(e.line,t.length-1)),r=Math.max(0,Math.min(e.ch,t[l]?.length??0));return{line:l,ch:r}}let n,s,k,M;if(f)n=f.start.trim(),s=f.end.trim(),k=f.start.endsWith(" ")?f.start:f.start+" ",M=f.end.startsWith(" ")?f.end:" "+f.end;else{let e=this.settings.template,t=e.indexOf("{cursor}"),l=e,r="";t!==-1&&(l=e.slice(0,t),r=e.slice(t+8)),n=l.trim(),s=r.trim(),k=n+(n&&!n.endsWith(" ")?" ":""),M=(s&&!s.startsWith(" ")?" ":"")+s}let u=i.getSelection(),a=i.getCursor(),p,o=i.getCursor("from"),x=i.getCursor("to"),d=null,C=i.getLine(a.line);function H(e,t){let l=/[\p{L}\p{N}_]+/gu,r;for(;(r=l.exec(e))!==null;)if(t>=r.index&&t<=r.index+r[0].length)return{start:r.index,end:r.index+r[0].length};return null}function G(e,t,l){return t?l?e.startsWith(t)&&e.endsWith(l):e.startsWith(t):!1}function _(e,t,l,r,L,P){let v=r.trim(),$=L.trim();if(P==="back")for(let g=t;g>=0;g--){let h=e[g],m=g===t?l:h.length;for(let b=m-1;b>=0;b--){if(h.substr(b,v.length)===v)return{type:"marker",pos:{line:g,ch:b}};if(h.substr(b,$.length)===$)return{type:"opposite",pos:{line:g,ch:b}}}}else for(let g=t;g<e.length;g++){let h=e[g],m=g===t?l:0;for(let b=m;b<=h.length-Math.min(v.length,$.length);b++){if(h.substr(b,v.length)===v)return{type:"marker",pos:{line:g,ch:b}};if(h.substr(b,$.length)===$)return{type:"opposite",pos:{line:g,ch:b}}}}return{type:null,pos:null}}let I=!1,S=null,W=null,w=i.getValue().split(`
`);if(n&&s){let e,t;if(u){let l=_(w,o.line,o.ch,n,s,"back"),r=_(w,x.line,x.ch,s,n,"forward");e=l.type,t=r.type,e==="marker"&&(S=l.pos),t==="marker"&&(W=r.pos)}else{let l=_(w,a.line,a.ch,n,s,"back"),r=_(w,a.line,a.ch,s,n,"forward");e=l.type,t=r.type,e==="marker"&&(S=l.pos),t==="marker"&&(W=r.pos)}e==="marker"&&t==="marker"?I=!0:I=!1}if(z("comment:",I,{start:S?{line:S.line+1,ch:S.ch+1}:null,end:W?{line:W.line+1,ch:W.ch+1}:null}),u&&n&&s){let v=function(h,m){if(!m)return!1;for(let b=1;b<=m.length;b++)if(h.includes(m.slice(0,b))||h.includes(m.slice(-b)))return!0;return!1};var re=v;let e=i.getLine(o.line),t=u,l=!1,r=!1,L=t.indexOf(n),P=t.indexOf(s);if(!l&&v(t,n)){let h=e.slice(Math.max(0,o.ch-n.length),o.ch+t.length);h.includes(n)&&(l=!0,L=h.indexOf(n)-(o.ch-Math.max(0,o.ch-n.length)))}if(!r&&v(t,s)){let h=e.slice(o.ch,Math.min(e.length,x.ch+s.length));h.includes(s)&&(r=!0,P=h.indexOf(s))}if(t.includes(n)&&(l=!0,L=t.indexOf(n)),t.includes(s)&&(r=!0,P=t.indexOf(s)),n===s&&n.length>0&&(l||r)){let h=_(w,o.line,o.ch,n,"","back"),m=_(w,x.line,x.ch,s,"","forward");h.type==="marker"&&(S=h.pos),m.type==="marker"&&(W=m.pos),S&&W&&(I=!0)}else if(l&&!r){let h=o.line,m=e.indexOf(n,o.ch);m===-1&&(m=o.ch);let b=!1;for(let y=h;y<w.length;y++){let A=w[y],ee=y===h?m+n.length:0;for(let F=ee;F<=A.length-s.length;F++){if(A.substr(F,s.length)===s){S={line:h,ch:m},W={line:y,ch:F},I=!0,b=!0;break}if(A.substr(F,n.length)===n&&(y!==h||F!==m)){z("Stopped search for end marker: found another start marker first",{from:{line:h,ch:m},at:{line:y,ch:F}}),b=!0;break}}if(b)break}}else if(r&&!l){let h=x.line,m=e.indexOf(s,o.ch);m===-1&&(m=x.ch);let b=!1;for(let y=h;y>=0;y--){let A=w[y],ee=y===h?m-1:A.length-1;for(let F=ee;F>=0;F--){if(A.substr(F,n.length)===n){S={line:y,ch:F},W={line:h,ch:m},I=!0,b=!0;break}if(A.substr(F,s.length)===s&&(y!==h||F!==m)){z("Stopped search for start marker: found another end marker first",{from:{line:h,ch:m},at:{line:y,ch:F}}),b=!0;break}}if(b)break}}let $=o.ch<=n.length&&e.slice(0,n.length).startsWith(n),g=x.ch>=e.length-s.length&&e.slice(-s.length).endsWith(s);if(!$&&!g)return}if(u&&n&&s){let v=function(g,h){if(!h)return!1;for(let m=1;m<=h.length;m++)if(g.includes(h.slice(0,m))||g.includes(h.slice(-m)))return!0;return!1};var re=v;let e=i.getLine(o.line),t=u,l=!1,r=!1,L=t.indexOf(n),P=t.indexOf(s);if(!l&&v(t,n)){let g=e.slice(Math.max(0,o.ch-n.length),o.ch+t.length);g.includes(n)&&(l=!0,L=g.indexOf(n)-(o.ch-Math.max(0,o.ch-n.length)))}if(!r&&v(t,s)){let g=e.slice(o.ch,Math.min(e.length,x.ch+s.length));g.includes(s)&&(r=!0,P=g.indexOf(s))}if(t.includes(n)&&(l=!0,L=t.indexOf(n)),t.includes(s)&&(r=!0,P=t.indexOf(s)),n===s&&n.length>0&&(l||r)){let g=_(w,o.line,o.ch,n,"","back"),h=_(w,x.line,x.ch,s,"","forward");g.type==="marker"&&(S=g.pos),h.type==="marker"&&(W=h.pos),S&&W&&(I=!0)}else if(l){let g=_(w,x.line,x.ch,s,n,"forward");g.type==="marker"&&(W=g.pos);let h=o.line,m=e.indexOf(n,o.ch);m!==-1&&(S={line:h,ch:m}),S&&W&&(I=!0)}else if(r){let g=_(w,o.line,o.ch,n,s,"back");g.type==="marker"&&(S=g.pos);let h=x.line,m=e.indexOf(s,o.ch);m!==-1&&(W={line:h,ch:m}),S&&W&&(I=!0)}}if(I&&S&&W){let e=w[S.line],t=n+" ";w[S.line]=e.slice(0,S.ch)+e.slice(S.ch+t.length);let l=W.line,r=W.ch;if(S.line===W.line){r-=t.length;let y=w[l],A=" "+s;if(r=y.indexOf(A,r),r===-1&&(r=y.indexOf(s,r),r>0&&y[r-1]===" "&&(r=r-1)),r===-1)return;w[l]=y.slice(0,r)+y.slice(r+A.length)}else{let y=w[l],A=" "+s;w[l]=y.slice(0,r)+y.slice(r+A.length)}let L=Math.min(S.line,W.line),P=Math.max(S.line,W.line),v=w.slice(L,P+1).join(`
`);i.replaceRange(v,{line:L,ch:0},{line:P,ch:i.getLine(P).length});let $=o.line,g=o.ch-t.length;g<0&&(g=0);let h=w.length-1;$>h&&($=h);let m=w[$]?.length??0;g>m&&(g=m);let b=c({line:$,ch:g});i.setCursor(b);return}let V=!1;d=H(C,a.ch),u?V=!1:d&&(a.ch>d.start&&a.ch<d.end||this.settings.wordOnlyMode&&(a.ch===d.start||a.ch===d.end)?V=!0:V=!1),z("Mode:",u?"selection":V?"word":"insert",{selection:u,wordBounds:d,useWord:V}),u?p=u:V&&d?(p=C.slice(d.start,d.end),o={line:a.line,ch:d.start},x={line:a.line,ch:d.end}):(p="",o={line:a.line,ch:a.ch},x={line:a.line,ch:a.ch});let E=n,T=s,D=!1,B=p;if(u){if(E&&T&&u.startsWith(E)&&u.endsWith(T))D=!0,B=u;else for(let e of q)if(e.start&&e.end&&u.startsWith(e.start)&&u.endsWith(e.end)){E=e.start,T=e.end,D=!0,B=u;break}if(!D){let e=i.getLine(o.line),t=i.getLine(x.line);if(E&&T&&e.startsWith(E)&&t.endsWith(T))D=!0,B=i.getRange({line:o.line,ch:0},{line:x.line,ch:i.getLine(x.line).length});else for(let l of q)if(l.start&&l.end&&e.startsWith(l.start)&&t.endsWith(l.end)){E=l.start,T=l.end,D=!0,B=i.getRange({line:o.line,ch:0},{line:x.line,ch:i.getLine(x.line).length});break}}}else if(V&&d){if(E&&T&&C.startsWith(E)&&C.endsWith(T))D=!0,B=C;else for(let e of q)if(e.start&&e.end&&C.startsWith(e.start)&&C.endsWith(e.end)){E=e.start,T=e.end,D=!0,B=C;break}if(!D&&E&&T&&p.startsWith(E)&&p.endsWith(T))D=!0,B=p;else if(!D){for(let e of q)if(e.start&&e.end&&p.startsWith(e.start)&&p.endsWith(e.end)){E=e.start,T=e.end,D=!0,B=p;break}}}else if(E&&T&&C.startsWith(E)&&C.endsWith(T))D=!0,B=C;else for(let e of q)if(e.start&&e.end&&C.startsWith(e.start)&&C.endsWith(e.end)){E=e.start,T=e.end,D=!0,B=C;break}function ge(e,t,l,r,L){return{result:e,newStart:r,newEnd:L}}if(D){if(u&&E&&B===E){let e=i.getLine(o.line),t=e.indexOf(E),l=T?e.indexOf(T,t+E.length):-1;if(l!==-1){let r=e.slice(t+E.length,l);if(/^\s*$/.test(r)){z("Deleting end marker after deleting start marker",{line:o.line,startIdx:t,endIdx:l,removalUsedStart:E,removalUsedEnd:T});let L=e.slice(0,t),P=e.slice(l+T.length);i.setLine(o.line,L+P),i.setCursor({line:o.line,ch:t});return}}}return}let X=n,ne=s,j=!1,J=p;if(u?J=p:V&&d?J=C.slice(d.start,d.end):J=p,X&&G(J,X,ne))j=!0;else for(let e of q)if(e.start&&G(J,e.start,e.end)){X=e.start,ne=e.end,j=!0;break}function le(e){return n+" "+e+" "+s}function Y(e){let t=n+" ",l=" "+s;return e.startsWith(t)&&e.endsWith(l)?e.slice(t.length,e.length-l.length):e.startsWith(n)&&e.endsWith(s)?e.slice(n.length,e.length-s.length).trim():null}let N=null;if(u)N=Y(p),N!==null&&(j=!0);else if(V&&d){let e=C.slice(d.start,d.end);N=Y(e),N!==null&&(j=!0)}else N=Y(p),N!==null&&(j=!0);if(j){let e=N!==null?N:p;if(u){i.replaceSelection(e);let t=c(o),l=c({line:x.line,ch:o.ch+e.length});i.setSelection(t,l)}else if(V&&d){i.replaceRange(e,{line:a.line,ch:d.start},{line:a.line,ch:d.end});let t=d.start+e.length,l=c({line:a.line,ch:t});i.setCursor(l)}else{i.replaceRange(e,{line:a.line,ch:a.ch},{line:a.line,ch:a.ch});let t=c({line:a.line,ch:a.ch});i.setCursor(t)}}else{let e=p.trim(),t;if(!u&&!e?t=n+"  "+s:t=le(e),!u&&!e){i.replaceRange(t,{line:a.line,ch:a.ch},{line:a.line,ch:a.ch});let l=a.ch+(n+" ").length,r=c({line:a.line,ch:l});i.setCursor(r)}else if(u){i.replaceSelection(t);let l=(n+" ").length,r=c({line:o.line,ch:o.ch+l}),L=c({line:x.line,ch:o.ch+l+e.length});i.setSelection(r,L)}else if(V&&d){i.replaceRange(t,{line:a.line,ch:d.start},{line:a.line,ch:d.end});let l=d.start+(n+" ").length,r=c({line:a.line,ch:l});i.setCursor(r)}else{i.replaceRange(t,{line:a.line,ch:a.ch},{line:a.line,ch:a.ch});let l=c({line:a.line,ch:a.ch+(n+" ").length});i.setCursor(l)}}let Z=c(i.getCursor());(Z.line!==i.getCursor().line||Z.ch!==i.getCursor().ch)&&i.setCursor(Z)}toggleCommentAtCursor(i){let f=this.settings.template,c=f.indexOf("{cursor}"),n=f,s="";c!==-1&&(n=f.slice(0,c),s=f.slice(c+8));let k=n.trim(),M=s.trim(),u=i.getCursor(),a=i.getLine(u.line),p=a.indexOf(k),o=M?a.lastIndexOf(M):-1,x=!1;if(k&&M?x=p!==-1&&o!==-1&&u.ch>=p+k.length&&u.ch<=o:k&&(x=p!==-1&&u.ch>=p+k.length),x){let d=a;k&&(d=d.replace(k,"")),M&&(d=d.replace(M,"")),d=d.trim(),i.setLine(u.line,d)}}};
//# sourceMappingURL=main.js.map
